#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook to run CI checks locally
# Install with: git config core.hooksPath .githooks

echo "Running pre-commit checks..."

# Check if we have staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
  echo "No Go files staged, skipping Go checks"
  exit 0
fi

# Ensure frontend assets are built (required for embedding)
if [ ! -f "static/js/app.js" ] || [ ! -f "static/css/app.css" ]; then
  echo "Building frontend assets..."
  (cd web && bun install --frozen-lockfile && bun run build)
fi

# Run golangci-lint on staged files
echo "Running golangci-lint..."
if command -v golangci-lint >/dev/null 2>&1; then
  golangci-lint run --timeout=5m --config=.golangci.yml --new-from-rev=HEAD~1 ./...
else
  echo "Warning: golangci-lint not installed, skipping lint"
fi

# Run tests
echo "Running tests..."
go test -race -p 4 -parallel 4 ./...

echo "All pre-commit checks passed!"
